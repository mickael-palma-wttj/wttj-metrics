<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Linear Metrics Dashboard - <%= today %></title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    <%= File.read(File.join(WttjMetrics.root, 'lib/wttj_metrics/templates/assets/styles.css')) %>
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>&#128202; Linear Metrics Dashboard</h1>
      <p class="subtitle">Generated on <%= today %> • Last <%= days_to_show %> days (<%= cutoff_date %> to <%= today %>)</p>
      <button class="collapse-all-btn" onclick="toggleAllSections()">
        <span id="toggleAllIcon">▼</span> <span id="toggleAllText">Collapse All</span>
      </button>
    </header>
    
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title"><span class="chevron">▼</span> &#128200; Key Metrics</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="metrics-grid">
<% flow_metrics_presented.each do |presenter| %>
        <div class="metric-card">
          <span class="tooltip"><%= presenter.tooltip %></span>
          <div class="metric-value"><%= presenter.value %><%= presenter.unit %></div>
          <div class="metric-label"><%= presenter.label %></div>
        </div>
<% end %>
<% cycle_metrics_presented.each do |presenter| %>
        <div class="metric-card">
          <span class="tooltip"><%= presenter.tooltip %></span>
          <div class="metric-value"><%= presenter.value %><%= presenter.unit %></div>
          <div class="metric-label"><%= presenter.label %></div>
        </div>
<% end %>
<% team_metrics_presented.each do |presenter| %>
        <div class="metric-card">
          <span class="tooltip"><%= presenter.tooltip %></span>
          <div class="metric-value"><%= presenter.value %><%= presenter.unit %></div>
          <div class="metric-label"><%= presenter.label %></div>
        </div>
<% end %>
      </div>
      </div>
    </section>
    
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title"><span class="chevron">▼</span> &#128027; Bug Tracking</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="charts-grid">
        <div class="chart-card full-width">
          <h3 class="chart-title">Bug Overview</h3>
          <div class="metrics-grid" style="grid-template-columns: repeat(4, 1fr);">
<% bug_metrics_presented.each do |presenter| %>
            <div class="metric-card">
              <span class="tooltip"><%= presenter.tooltip %></span>
              <div class="metric-value"><%= presenter.value %><%= presenter.unit %></div>
              <div class="metric-label"><%= presenter.label %></div>
            </div>
<% end %>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Bug Status
            <span class="tooltip-icon">?
              <span class="tooltip-text">Distribution of bugs by their current status (Open vs Closed).</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="bugStatusChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Open Bugs by Priority
            <span class="tooltip-icon">?
              <span class="tooltip-text">Breakdown of currently open bugs by their priority level.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="bugsPriorityChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Bug Flow (Last <%= @days_to_show %> Days)<% unless all_teams_mode %><span class="filter-badge">Filtered<span class="tooltip-text">Teams: <%= team_mapping_display %></span></span><% end %>
            <span class="tooltip-icon">?
              <span class="tooltip-text">Weekly comparison of new bugs created vs bugs closed. Helps track if the backlog is growing or shrinking.</span>
            </span>
          </h3>
          <div class="chart-container tall">
            <canvas id="bugFlowChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Bugs Created by Team (Last <%= @days_to_show %> Days)<% unless all_teams_mode %><span class="filter-badge">Filtered<span class="tooltip-text">Teams: <%= team_mapping_display %></span></span><% end %>
            <span class="tooltip-icon">?
              <span class="tooltip-text">Weekly distribution of new bugs created, broken down by team.</span>
            </span>
          </h3>
          <div class="chart-container tall">
            <canvas id="bugsByTeamChart"></canvas>
          </div>
        </div>
        <div class="chart-card full-width">
          <h3 class="chart-title">
            Bug Stats by Team (All Time)<% unless all_teams_mode %><span class="filter-badge">Filtered<span class="tooltip-text">Teams: <%= team_mapping_display %></span></span><% end %>
            <span class="tooltip-icon">?
              <span class="tooltip-text">Comprehensive statistics for each team including total bugs, resolution time (MTTR), and resolution rate.</span>
            </span>
          </h3>
          <table class="data-table" id="bugStatsTable">
            <thead>
              <tr>
                <th class="sortable" onclick="sortTable('bugStatsTable', 0)">Team</th>
                <th class="sortable has-tooltip" onclick="sortTable('bugStatsTable', 1)">Total Created<span class="th-tooltip">Total bugs ever created for this team</span></th>
                <th class="sortable has-tooltip" onclick="sortTable('bugStatsTable', 2)">Closed<span class="th-tooltip">Bugs that have been resolved</span></th>
                <th class="sortable has-tooltip" onclick="sortTable('bugStatsTable', 3)">Open<span class="th-tooltip">Bugs currently open</span></th>
                <th class="sortable has-tooltip" onclick="sortTable('bugStatsTable', 4)">MTTR<span class="th-tooltip">Mean Time To Resolve (avg days to fix bugs)</span></th>
                <th class="sortable has-tooltip" onclick="sortTable('bugStatsTable', 5)">Resolution Rate<span class="th-tooltip">Percentage of bugs closed</span></th>
              </tr>
            </thead>
            <tbody>
<% bugs_by_team_presented.each do |presenter| %>
              <tr>
                <td><strong><%= presenter.name %></strong></td>
                <td><%= presenter.created %></td>
                <td><%= presenter.closed %></td>
                <td><%= presenter.open %></td>
                <td><%= presenter.mttr_display %></td>
                <td>
                  <div class="progress-bar">
                    <div class="progress-fill <%= presenter.resolution_rate_progress_class %>" style="width: <%= presenter.resolution_rate %>%"></div>
                  </div>
                  <small><%= presenter.resolution_rate_display %></small>
                </td>
              </tr>
<% end %>
            </tbody>
          </table>
        </div>
      </div>
      </div>
    </section>
    
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title"><span class="chevron">▼</span> &#128640; Ticket Flow (Last <%= @days_to_show %> Days)</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="charts-grid">
        <div class="chart-card">
          <h3 class="chart-title">
            Tickets Created vs Completed<% unless all_teams_mode %><span class="filter-badge">Filtered<span class="tooltip-text">Teams: <%= team_mapping_display %></span></span><% end %>
            <span class="tooltip-icon">?
              <span class="tooltip-text">Weekly flow of all tickets (features, bugs, chores) created vs completed.</span>
            </span>
          </h3>
          <div class="chart-container tall">
            <canvas id="flowChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            State Transitions Distribution<% unless all_teams_mode %><span class="filter-badge">Filtered<span class="tooltip-text">Teams: <%= team_mapping_display %></span></span><% end %>
            <span class="tooltip-icon">?
              <span class="tooltip-text">Weekly breakdown of ticket statuses. Shows how work moves through the workflow stages.</span>
            </span>
          </h3>
          <div class="chart-container tall">
            <canvas id="transitionChart"></canvas>
          </div>
        </div>
      </div>
      </div>
    </section>
    
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title"><span class="chevron">▼</span> &#128200; Current Distribution</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="charts-grid">
        <div class="chart-card">
          <h3 class="chart-title">
            Status Distribution
            <span class="tooltip-icon">?
              <span class="tooltip-text">Current snapshot of all tickets by their status.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Priority Distribution
            <span class="tooltip-icon">?
              <span class="tooltip-text">Current snapshot of all tickets by their priority.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="priorityChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Issue Type Distribution
            <span class="tooltip-icon">?
              <span class="tooltip-text">Current snapshot of all tickets by their type (Feature, Bug, etc.).</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="typeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Top Assignees (WIP)
            <span class="tooltip-icon">?
              <span class="tooltip-text">Team members with the most currently active tickets.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="assigneeChart"></canvas>
          </div>
        </div>
      </div>
      </div>
    </section>
    
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title"><span class="chevron">▼</span> &#128101; Team Comparison<% unless all_teams_mode %><span class="filter-badge">Filtered<span class="tooltip-text">Teams: <%= team_mapping_display %></span></span><% end %></h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="chart-card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Team</th>
              <th class="has-tooltip">Cycles (with data)<span class="th-tooltip">Number of cycles with actual work data vs total cycles</span></th>
              <th class="has-tooltip">Avg Velocity<span class="th-tooltip">Average story points completed per cycle</span></th>
              <th class="has-tooltip">Avg Tickets/Cycle<span class="th-tooltip">Average number of tickets completed per cycle</span></th>
              <th class="has-tooltip">Avg Assignees<span class="th-tooltip">Average number of team members working per cycle</span></th>
              <th class="has-tooltip">Avg Tickets/Day<span class="th-tooltip">Average tickets completed per day during cycles</span></th>
              <th class="has-tooltip">Avg Completion<span class="th-tooltip">Average percentage of planned work completed</span></th>
              <th class="has-tooltip">Total Carryover<span class="th-tooltip">Total issues carried over from previous cycles</span></th>
              <th class="has-tooltip">Avg Scope Change<span class="th-tooltip">Average change in sprint scope during cycles</span></th>
            </tr>
          </thead>
          <tbody>
<% team_stats.each do |team, stats| %>
            <tr>
              <td><strong><%= team %></strong></td>
              <td><%= stats[:cycles_with_data] %>/<%= stats[:total_cycles] %></td>
              <td><%= stats[:avg_velocity] %> pts</td>
              <td><%= stats[:avg_tickets_per_cycle] %></td>
              <td><%= stats[:avg_assignees] %></td>
              <td><%= stats[:avg_tickets_per_day] %></td>
              <td>
                <div class="progress-bar"><div class="progress-fill <%= stats[:avg_completion_rate] >= 80 ? 'completion-high' : stats[:avg_completion_rate] >= 50 ? 'completion-medium' : 'completion-low' %>" style="width: <%= stats[:avg_completion_rate] %>%"></div></div>
                <small><%= stats[:avg_completion_rate] %>%</small>
              </td>
              <td><%= stats[:total_carryover] %></td>
              <td class="<%= stats[:avg_scope_change] > 0 ? 'scope-increased' : stats[:avg_scope_change] < 0 ? 'scope-decreased' : 'scope-neutral' %>"><%= stats[:avg_scope_change] > 0 ? '+' : '' %><%= stats[:avg_scope_change] %>%</td>
            </tr>
<% end %>
          </tbody>
        </table>
      </div>
      </div>
    </section>
    
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title"><span class="chevron">▼</span> &#128197; Cycles by Team<% unless all_teams_mode %><span class="filter-badge">Filtered<span class="tooltip-text">Teams: <%= team_mapping_display %></span></span><% end %></h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
<% cycles_by_team_presented.each do |team, cycles| %>
      <div class="chart-card" style="margin-bottom: 1.5rem;">
        <h3 class="chart-title"><%= team %></h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Cycle</th>
              <th>Status</th>
              <th class="has-tooltip">Progress<span class="th-tooltip">Percentage of issues completed</span></th>
              <th class="has-tooltip">Issues<span class="th-tooltip">Completed / Total issues</span></th>
              <th class="has-tooltip">Bugs<span class="th-tooltip">Bug issues in this cycle</span></th>
              <th class="has-tooltip">Assignees<span class="th-tooltip">Team members assigned</span></th>
              <th class="has-tooltip">Velocity<span class="th-tooltip">Story points completed</span></th>
              <th class="has-tooltip">Tickets/Day<span class="th-tooltip">Average per day</span></th>
              <th class="has-tooltip">Carryover<span class="th-tooltip">From previous cycles</span></th>
              <th class="has-tooltip">Scope Change<span class="th-tooltip">Change in sprint scope during cycle</span></th>
            </tr>
          </thead>
          <tbody>
<% cycles.each do |presenter| %>
            <tr>
              <td><%= presenter.name %></td>
              <td><span class="status-badge <%= presenter.status_class %>"><%= presenter.status %></span></td>
              <td>
                <div class="progress-bar"><div class="progress-fill <%= presenter.completion_rate_class %>" style="width: <%= presenter.progress %>%"></div></div>
                <small><%= presenter.progress %>%</small>
              </td>
              <td><%= presenter.issues_display %></td>
              <td><%= presenter.bug_count %></td>
              <td><%= presenter.assignee_count %></td>
              <td><%= presenter.velocity_display %></td>
              <td><%= presenter.tickets_per_day %></td>
              <td><%= presenter.carryover %></td>
              <td class="<%= presenter.scope_change_class %> has-tooltip"><%= presenter.scope_change_display %><span class="cell-tooltip"><%= presenter.scope_change_tooltip %></span></td>
            </tr>
<% end %>
          </tbody>
        </table>
      </div>
<% end %>
      </div>
    </section>
    
    <footer>
      <p>Data sourced from Linear API • Report generated by WTTJ Metrics Collector</p>
    </footer>
  </div>
  
  <script>
    <%= File.read(File.join(WttjMetrics.root, 'lib/wttj_metrics/templates/assets/scripts.js')) %>
    
    // Initialize default sort on page load
    window.addEventListener('DOMContentLoaded', () => {
      if (document.getElementById('bugStatsTable')) {
        sortTable('bugStatsTable', 5); // Sort by Resolution Rate (column 5)
        sortTable('bugStatsTable', 5); // Toggle to descending
      }
    });
    
    // Store chart instances for resize handling
    const chartInstances = {};
    
    // Function to create all charts
    function createCharts() {
      // Destroy existing charts
      Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
      });
      
<% flow = weekly_flow_data %>
    // Flow Chart
    const createdRaw = <%= flow[:created_raw].to_json %>;
    const completedRaw = <%= flow[:completed_raw].to_json %>;
    
    chartInstances.flow = createStackedBarChart(
      'flowChart',
      <%= flow[:labels].to_json %>,
      [
        { label: 'Created', data: <%= flow[:created_pct].to_json %>, backgroundColor: colors.black, raw: createdRaw },
        { label: 'Completed', data: <%= flow[:completed_pct].to_json %>, backgroundColor: colors.yellow, raw: completedRaw }
      ],
      {
        interaction: { intersect: false, mode: 'index' }
      }
    );
    
<% trans = transition_weekly_data %>
    // Transition Chart
    const transitionColors = {
      'Backlog': 'rgba(148, 163, 184, 0.8)',
      'Todo': 'rgba(59, 130, 246, 0.8)',
      'In Progress': 'rgba(255, 205, 0, 0.9)',
      'In Review': 'rgba(88, 88, 88, 0.8)',
      'Testing': 'rgba(249, 115, 22, 0.8)',
      'Done': 'rgba(34, 197, 94, 0.8)',
      'Canceled': 'rgba(220, 38, 38, 0.8)',
    };
    
    chartInstances.transition = createStackedBarChart(
      'transitionChart',
      <%= trans[:labels].to_json %>,
      [
<% STATE_CATEGORIES.keys.each_with_index do |state, i| %>
          { label: '<%= state %>', data: <%= trans[:datasets][state][:percentages].to_json %>, backgroundColor: transitionColors['<%= state %>'], raw: <%= trans[:datasets][state][:raw].to_json %> }<%= i < STATE_CATEGORIES.keys.size - 1 ? ',' : '' %>
<% end %>
      ],
      {
        interaction: { intersect: false, mode: 'index' }
      }
    );

<% sorted_bugs = bugs_by_priority.sort_by { |m| %w[Urgent High Medium Low].index(m[:metric]) || 99 } %>
<% 
  open_bugs_count = bug_metrics.find { |m| m[:metric] == 'open_bugs' }&.dig(:value).to_i
  closed_bugs_count = bug_metrics.find { |m| m[:metric] == 'closed_bugs' }&.dig(:value).to_i
%>
    // Bug Status (Open vs Closed)
    chartInstances.bugStatus = createDoughnutChart(
      'bugStatusChart',
      ['Open', 'Closed'],
      [{ data: [<%= open_bugs_count %>, <%= closed_bugs_count %>], backgroundColor: [colors.red, colors.green], borderWidth: 0 }],
      { plugins: { legend: { labels: { boxWidth: 12, padding: 8 } } } }
    );

    // Bugs by Priority
    const bugsPriorityColors = { 'Urgent': colors.red, 'High': colors.orange, 'Medium': colors.yellow, 'Low': colors.green, 'No priority': 'rgba(148, 163, 184, 0.8)' };
    const bugsPriorityLabels = <%= sorted_bugs.map { |m| m[:metric] }.to_json %>;
    const bugsPriorityData = <%= sorted_bugs.map { |m| m[:value].to_i }.to_json %>;
    
    chartInstances.bugsPriority = createDoughnutChart(
      'bugsPriorityChart',
      bugsPriorityLabels,
      [{ data: bugsPriorityData, backgroundColor: bugsPriorityLabels.map(l => bugsPriorityColors[l] || colors.cyan), borderWidth: 0 }],
      { plugins: { legend: { labels: { boxWidth: 12, padding: 8 } } } }
    );

    // Bug Flow Chart
<% bug_flow = weekly_bug_flow_data %>
    chartInstances.bugFlow = createStackedBarChart(
      'bugFlowChart',
      <%= bug_flow[:labels].to_json %>,
      [
        { label: 'Bugs Created', data: <%= bug_flow[:created_pct].to_json %>, backgroundColor: 'rgba(220, 38, 38, 0.8)', borderRadius: 0, raw: <%= bug_flow[:created].to_json %> },
        { label: 'Bugs Closed', data: <%= bug_flow[:closed_pct].to_json %>, backgroundColor: 'rgba(34, 197, 94, 0.8)', borderRadius: 0, raw: <%= bug_flow[:closed].to_json %> }
      ]
    );

    // Bugs by Team Stacked Bar Chart (100%)
<% bug_flow_by_team = weekly_bug_flow_by_team_data %>
    // Extended color palette for dynamic team colors
    const teamColorPalette = [
      colors.blue, colors.green, colors.yellow, colors.orange,
      colors.purple, colors.pink, colors.cyan, colors.red,
      colors.lime, colors.indigo, colors.rose, colors.teal,
      colors.amber, colors.violet, colors.emerald, colors.deepOrange,
      colors.lightBlue, colors.lightGreen, colors.deepPurple, colors.fuchsia,
      colors.brown, colors.slate, colors.grey, colors.black
    ];
    
    // Build teamColors dynamically from available teams
    const allTeams = <%= bug_flow_by_team[:teams].keys.to_json %>;
    const teamColors = {};
    allTeams.forEach((team, idx) => {
      teamColors[team] = teamColorPalette[idx % teamColorPalette.length];
    });

    // Calculate percentages for 100% stacked chart
    const teamLabels = <%= bug_flow_by_team[:labels].to_json %>;
    const teamRawData = {
<% bug_flow_by_team[:teams].each_with_index do |(team, data), idx| %>
      '<%= team %>': <%= data[:created].to_json %><%= idx < bug_flow_by_team[:teams].size - 1 ? ',' : '' %>
<% end %>
    };
    
    // Calculate totals per week and percentages
    const weekTotals = teamLabels.map((_, i) => 
      Object.values(teamRawData).reduce((sum, arr) => sum + (arr[i] || 0), 0)
    );
    
    const teamPctData = {};
    Object.keys(teamRawData).forEach(team => {
      teamPctData[team] = teamRawData[team].map((val, i) => 
        weekTotals[i] > 0 ? ((val / weekTotals[i]) * 100).toFixed(1) : 0
      );
    });

    chartInstances.bugsByTeam = createStackedBarChart(
      'bugsByTeamChart',
      teamLabels,
      Object.keys(teamRawData).map(team => ({
        label: team,
        data: teamPctData[team],
        backgroundColor: teamColors[team] || 'rgba(148, 163, 184, 0.8)',
        borderRadius: 0,
        raw: teamRawData[team]
      }))
    );

    // Status Chart
    const statusColors = { 'Backlog': 'rgba(148, 163, 184, 0.8)', 'To Do': 'rgba(59, 130, 246, 0.8)', 'In Progress': 'rgba(255, 205, 0, 0.9)', 'In Review': 'rgba(88, 88, 88, 0.8)', 'Done': 'rgba(34, 197, 94, 0.8)' };
    const statusLabels = <%= status_chart_data.map { |d| d[:label] }.to_json %>;
    const statusBreakdown = <%= status_chart_data.map { |d| d[:breakdown] }.to_json %>;
    
    chartInstances.status = createDoughnutChart(
      'statusChart',
      statusLabels,
      [{ data: <%= status_chart_data.map { |d| d[:value] }.to_json %>, backgroundColor: statusLabels.map(l => statusColors[l] || colors.purple), borderWidth: 0 }],
      {
        plugins: {
          legend: { labels: { boxWidth: 12, padding: 8 } },
          tooltip: {
            callbacks: {
              label: ctx => {
                const breakdown = statusBreakdown[ctx.dataIndex];
                const lines = [`${ctx.label}: ${ctx.parsed} total`];
                if (breakdown && breakdown.length > 0) {
                  lines.push('───────');
                  breakdown.forEach(b => lines.push(`  ${b.name}: ${b.count}`));
                }
                return lines;
              }
            }
          }
        }
      }
    );
    
    // Priority Chart
    chartInstances.priority = createDoughnutChart(
      'priorityChart',
      <%= priority_chart_data.map { |d| d[:label] }.to_json %>,
      [{ data: <%= priority_chart_data.map { |d| d[:value] }.to_json %>, backgroundColor: ['rgba(148, 163, 184, 0.8)', 'rgba(34, 197, 94, 0.8)', 'rgba(255, 205, 0, 0.9)', 'rgba(249, 115, 22, 0.8)', 'rgba(220, 38, 38, 0.8)'], borderWidth: 0 }],
      { plugins: { legend: { labels: { boxWidth: 12, padding: 8 } } } }
    );
    
    // Type Chart
    chartInstances.type = createDoughnutChart(
      'typeChart',
      <%= type_chart_data.map { |d| d[:label] }.to_json %>,
      [{
        data: <%= type_chart_data.map { |d| d[:value] }.to_json %>,
        backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(249, 115, 22, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)', 'rgba(156, 163, 175, 0.8)'],
        borderWidth: 0,
        breakdown: <%= type_chart_data.map { |d| d[:breakdown] }.to_json %>
      }],
      {
        plugins: {
          legend: { labels: { boxWidth: 12, padding: 8 } },
          tooltip: {
            callbacks: {
              afterLabel: function(context) {
                const breakdown = context.dataset.breakdown[context.dataIndex];
                if (!breakdown || Object.keys(breakdown).length === 0) return [];

                const lines = [];
                const sorted = Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
                sorted.forEach(([label, count]) => {
                  lines.push(`  ${label}: ${count}`);
                });
                return lines;
              }
            }
          }
        }
      }
    );
    
    // Assignee Chart
    chartInstances.assignee = createBarChart(
      'assigneeChart',
      <%= assignee_chart_data.map { |d| d[:label] }.to_json %>,
      [{ label: 'Active Issues', data: <%= assignee_chart_data.map { |d| d[:value] }.to_json %>, backgroundColor: 'rgba(255, 205, 0, 0.9)', borderRadius: 4 }],
      {
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true } }
      }
    );
    }
    
    // Create charts on load
    createCharts();
    
    // Debounced resize handler to recreate charts
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        createCharts();
      }, 250);
    });
  </script>
</body>
</html>
