<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Metrics Dashboard - <%= @today %></title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    <%= File.read(File.join(WttjMetrics.root, 'lib/wttj_metrics/templates/assets/styles.css')) %>
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>&#128025; GitHub Metrics Dashboard</h1>
      <p class="subtitle">Generated on <%= @today %> • Last <%= days_to_show %> days (<%= cutoff_date %> to <%= @today %>)</p>
      <button class="collapse-all-btn" onclick="toggleAllSections()">
        <span id="toggleAllIcon">▼</span> <span id="toggleAllText">Collapse All</span>
      </button>
    </header>
    
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title" id="key-metrics"><span class="chevron">▼</span> &#128200; Key Metrics</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="metrics-grid">
        <div class="metric-card">
          <span class="tooltip">Average time from PR creation to merge</span>
          <div class="metric-value"><%= metrics[:avg_time_to_merge].round(1) %>d</div>
          <div class="metric-label">Avg Time to Merge</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Total number of PRs merged in the period</span>
          <div class="metric-value"><%= metrics[:total_merged].to_i %></div>
          <div class="metric-label">Total Merged PRs</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Average number of reviews per PR</span>
          <div class="metric-value"><%= metrics[:avg_reviews].round(1) %></div>
          <div class="metric-label">Avg Reviews / PR</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Average number of comments per PR</span>
          <div class="metric-value"><%= metrics[:avg_comments].round(1) %></div>
          <div class="metric-label">Avg Comments / PR</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Average time from PR creation to first review</span>
          <div class="metric-value"><%= metrics[:avg_time_to_first_review].round(1) %>d</div>
          <div class="metric-label">Avg Time to First Review</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Percentage of resolved PRs that were merged</span>
          <div class="metric-value"><%= metrics[:merge_rate].round(1) %>%</div>
          <div class="metric-label">Acceptance Rate</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Average time from PR creation to first approval</span>
          <div class="metric-value"><%= metrics[:avg_time_to_approval].round(1) %>d</div>
          <div class="metric-label">Time to Approval</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Average number of 'Changes Requested' reviews per PR</span>
          <div class="metric-value"><%= metrics[:avg_rework_cycles].round(1) %></div>
          <div class="metric-label">Rework Cycles</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Percentage of merged PRs with successful CI status</span>
          <div class="metric-value"><%= metrics[:ci_success_rate].round(1) %>%</div>
          <div class="metric-label">CI Success Rate</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Average number of releases per day</span>
          <div class="metric-value"><%= metrics[:deploy_frequency_daily].round(1) %></div>
          <div class="metric-label">Daily Deploys</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Average lines added per PR</span>
          <div class="metric-value"><%= metrics[:avg_additions].to_i %></div>
          <div class="metric-label">Avg Additions / PR</div>
        </div>
        <div class="metric-card">
          <span class="tooltip">Average lines deleted per PR</span>
          <div class="metric-value"><%= metrics[:avg_deletions].to_i %></div>
          <div class="metric-label">Avg Deletions / PR</div>
        </div>
      </div>
      </div>
    </section>
    
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title" id="efficiency-trends"><span class="chevron">▼</span> &#128640; Efficiency Trends</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="charts-grid">
        <div class="chart-card">
          <h3 class="chart-title">
            Time to Merge History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Average time from PR creation to merge. Tracks how quickly code is integrated.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="timeToMergeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Time to First Review History (Days)
            <span class="tooltip-icon">?
              <span class="tooltip-text">Average time from PR creation to the first review comment. Indicates review responsiveness.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="timeToFirstReviewChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Time to Approval History (Days)
            <span class="tooltip-icon">?
              <span class="tooltip-text">Average time from PR creation to the first approval. Measures review cycle efficiency.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="timeToApprovalChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Weekly Deployment Frequency
            <span class="tooltip-icon">?
              <span class="tooltip-text">Number of releases created per week. Indicates delivery cadence.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="deployFrequencyChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Time to First Review (P50/P75/P90/P95)
            <span class="tooltip-icon">?
              <span class="tooltip-text">Distribution of time from PR open to first review. Target: P90 < 1 day.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="timeToReviewPercentilesChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Time to Merge (P50/P75/P90/P95)
            <span class="tooltip-icon">?
              <span class="tooltip-text">Full PR cycle time distribution. P50 is typical, P90 shows slow PRs.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="timeToMergePercentilesChart"></canvas>
          </div>
        </div>
      </div>
      </div>
    </section>

    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title" id="quality-health-trends"><span class="chevron">▼</span> &#129658; Quality & Health Trends</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="charts-grid">
        <div class="chart-card">
          <h3 class="chart-title">
            CI Success Rate History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Percentage of PRs where the last commit passed all CI checks. Indicates build stability.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="ciSuccessRateChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Acceptance Rate History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Percentage of PRs merged vs closed (Merged / (Merged + Closed)). Higher means less wasted effort.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="mergeRateChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Unreviewed PR Rate History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Percentage of PRs merged without any review. Should be close to 0% for code quality.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="unreviewedPRRateChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Hotfix Rate History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Percentage of releases tagged as hotfixes. Lower indicates better release stability.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="hotfixRateChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Time to Green History (Hours)
            <span class="tooltip-icon">?
              <span class="tooltip-text">Average time from PR creation to passing CI checks. Lower means faster feedback loops.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="timeToGreenChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            PR Outcome History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Weekly distribution of PRs by status (Merged, Closed, Open).</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="dailyBreakdownChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            PR Size History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Average lines added and deleted per PR. Smaller PRs are easier to review and merge.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="prSizeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            PR Size Distribution
            <span class="tooltip-icon">?
              <span class="tooltip-text">Lines changed per PR. Smaller PRs are easier to review. Target: P90 < 400 lines.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="prSizePercentilesChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            CI Time to Green (P50/P75/P90/P95)
            <span class="tooltip-icon">?
              <span class="tooltip-text">CI pipeline duration distribution. Target: P90 < 30 min.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="timeToGreenPercentilesChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            CI Success Rate Distribution
            <span class="tooltip-icon">?
              <span class="tooltip-text">Distribution of CI pass rates. Target: P50 > 90%.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="ciSuccessHistogramChart"></canvas>
          </div>
        </div>
      </div>
      </div>
    </section>

    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title" id="collaboration-trends"><span class="chevron">▼</span> &#129309; Collaboration Trends</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
      <div class="charts-grid">
        <div class="chart-card">
          <h3 class="chart-title">
            Reviews per PR History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Average number of reviews per PR. Indicates level of team collaboration and code scrutiny.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="reviewsChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Comments per PR History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Average number of comments per PR. Indicates level of discussion and feedback.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="commentsChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Rework Cycles History
            <span class="tooltip-icon">?
              <span class="tooltip-text">Average number of times changes were requested. Lower means clearer requirements and code.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="reworkCyclesChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Top 10 Active Repositories (PRs Created)
            <span class="tooltip-icon">?
              <span class="tooltip-text">Repositories with the most Pull Requests created during the selected period.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="topReposChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Top 10 Active Contributors (PRs Created)
            <span class="tooltip-icon">?
              <span class="tooltip-text">Authors with the most Pull Requests created during the selected period.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="topContributorsChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">
            Weekly PR Throughput
            <span class="tooltip-icon">?
              <span class="tooltip-text">PRs created vs merged per week with P50 baselines.</span>
            </span>
          </h3>
          <div class="chart-container">
            <canvas id="weeklyThroughputChart"></canvas>
          </div>
        </div>
      </div>
      </div>
    </section>

    <!-- Commit Activity Heatmap -->
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title" id="commit-activity-heatmap"><span class="chevron">▼</span> &#128197; Commit Activity Heatmap</h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
        <div class="charts-grid">
          <div class="chart-card full-width">
          <div class="chart-header-controls">
            <h3 class="chart-title">
              Commits by Day and Hour
              <span class="tooltip-icon">?
                <span class="tooltip-text">Heatmap showing commit frequency. Darker colors indicate higher activity.</span>
              </span>
            </h3>
            <div class="toggle-wrapper">
              <span class="toggle-label">Exclude Bots</span>
              <label class="toggle-switch">
                <input type="checkbox" id="excludeBotsToggle" onchange="toggleBotExclusion(this)">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <div class="heatmap-container" id="heatmap-container">
            <!-- Heatmap rendered by JS -->
          </div>
        </div>
          </div>
      </div>
    </section>

    <!-- Team Metrics Table -->
    <section>
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title" id="team-metrics"><span class="chevron">▼</span> &#128101; Team Metrics<% unless all_teams_mode %><span class="filter-badge">Filtered<span class="tooltip-text">Teams:<br><%= team_mapping_display %></span></span><% end %></h2>
        <label class="toggle-switch" onclick="event.stopPropagation()">
          <input type="checkbox" checked onchange="toggleSectionByCheckbox(this)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="section-content">
        <div class="charts-grid">
          <div class="chart-card full-width">
            <div class="search-container">
              <input type="text" id="teamSearch" placeholder="Search teams..." oninput="filterTable('teamSearch', 'teamMetricsTable')" class="search-input">
            </div>
            <div class="table-wrapper">
              <table id="teamMetricsTable" class="data-table">
            <thead>
              <tr>
                <th onclick="sortTable('teamMetricsTable', 0)" class="sortable">Team</th>
                <th onclick="sortTable('teamMetricsTable', 1)" class="sortable">Merged PRs<br><span>Total: <%= metrics[:total_merged].to_i %></span></th>
                <th onclick="sortTable('teamMetricsTable', 2)" class="sortable">Avg Time to Merge (d)<br><span>Avg: <%= format_metric_value(metrics[:avg_time_to_merge]) %></span></th>
                <th onclick="sortTable('teamMetricsTable', 3)" class="sortable">Avg Reviews<br><span>Avg: <%= format_metric_value(metrics[:avg_reviews]) %></span></th>
                <th onclick="sortTable('teamMetricsTable', 4)" class="sortable">Unreviewed Rate (%)<br><span>Avg: <%= format_metric_value(metrics[:unreviewed_pr_rate]) %></span></th>
                <th onclick="sortTable('teamMetricsTable', 5)" class="sortable">Merge Rate (%)<br><span>Avg: <%= format_metric_value(metrics[:merge_rate]) %></span></th>
                <th onclick="sortTable('teamMetricsTable', 6)" class="sortable">CI Success (%)<br><span>Avg: <%= format_metric_value(metrics[:ci_success_rate]) %></span></th>
              </tr>
            </thead>
            <tbody>
              <% team_metrics.sort.each do |team_name, data| %>
                <tr class="team-row">
                  <td><%= team_name %></td>
                  <td><%= data[:metrics][:total_merged].to_i %></td>
                  <td <%= metric_color_class(data[:metrics][:avg_time_to_merge], metrics[:avg_time_to_merge], inverse: true) %>>
                    <%= format_metric_value(data[:metrics][:avg_time_to_merge]) %>
                  </td>
                  <td <%= metric_color_class(data[:metrics][:avg_reviews], metrics[:avg_reviews]) %>>
                    <%= format_metric_value(data[:metrics][:avg_reviews]) %>
                  </td>
                  <td>
                    <div class="progress-bar">
                      <div class="progress-fill <%= metric_color_class(data[:metrics][:unreviewed_pr_rate], metrics[:unreviewed_pr_rate], inverse: true, return_class_only: true) %>" style="width: <%= data[:metrics][:unreviewed_pr_rate] %>%"></div>
                    </div>
                    <small><%= format_metric_value(data[:metrics][:unreviewed_pr_rate]) %>%</small>
                  </td>
                  <td>
                    <div class="progress-bar">
                      <div class="progress-fill <%= metric_color_class(data[:metrics][:merge_rate], metrics[:merge_rate], return_class_only: true) %>" style="width: <%= data[:metrics][:merge_rate] %>%"></div>
                    </div>
                    <small><%= format_metric_value(data[:metrics][:merge_rate]) %>%</small>
                  </td>
                  <td>
                    <div class="progress-bar">
                      <div class="progress-fill <%= metric_color_class(data[:metrics][:ci_success_rate], metrics[:ci_success_rate], return_class_only: true) %>" style="width: <%= data[:metrics][:ci_success_rate] %>%"></div>
                    </div>
                    <small><%= format_metric_value(data[:metrics][:ci_success_rate]) %>%</small>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sticky Table of Contents -->
    <button class="toc-fab" onclick="toggleToc()" title="Table of Contents">
      &#9776;
    </button>
    <div class="toc-menu" id="tocMenu">
      <h3>Table of Contents</h3>
      <ul>
        <li><a href="#key-metrics" onclick="toggleToc()">Key Metrics</a></li>
        <li><a href="#efficiency-trends" onclick="toggleToc()">Efficiency Trends</a></li>
        <li><a href="#quality-health-trends" onclick="toggleToc()">Quality & Health Trends</a></li>
        <li><a href="#collaboration-trends" onclick="toggleToc()">Collaboration Trends</a></li>
        <li><a href="#commit-activity-heatmap" onclick="toggleToc()">Commit Activity Heatmap</a></li>
        <li><a href="#team-metrics" onclick="toggleToc()">Team Metrics</a></li>
      </ul>
    </div>

    <footer>
      <p>Data sourced from GitHub API • Report generated by WTTJ Metrics Collector</p>
    </footer>
  </div>
  
  <script>
    <%= File.read(File.join(WttjMetrics.root, 'lib/wttj_metrics/templates/assets/scripts.js')) %>
    
    
    <% breakdown = weekly_breakdown %>
    const breakdownLabels = <%= breakdown[:labels].to_json %>;
    const globalMetrics = <%= metrics.to_json %>;

    // Store chart instances for resize handling
    const chartInstances = {};
    
    // Function to create all charts
    function createCharts() {
      // Destroy existing charts
      Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
      });
      
    // Time to Merge Chart
    const avgTimeMergeHours = <%= breakdown[:datasets][:avg_time_to_merge].to_json %>;
    const avgTimeMergeDays = avgTimeMergeHours.map(h => (h / 24).toFixed(2));

    chartInstances.timeToMerge = createMetricLineChart(
      'timeToMergeChart',
      breakdownLabels,
      avgTimeMergeDays,
      'Avg Time to Merge (Days)',
      colors.blue,
      globalMetrics.avg_time_to_merge
    );

    // Time to First Review Chart
    const avgTimeFirstReviewRaw = <%= breakdown[:datasets][:avg_time_to_first_review].to_json %>;
    // Data is already in days
    const avgTimeFirstReviewDays = avgTimeFirstReviewRaw.map(d => Number(d).toFixed(2));

    chartInstances.timeToFirstReview = createMetricLineChart(
      'timeToFirstReviewChart',
      breakdownLabels,
      avgTimeFirstReviewDays,
      'Avg Time to First Review (Days)',
      colors.cyan,
      globalMetrics.avg_time_to_first_review
    );

    // Time to Approval Chart
    chartInstances.timeToApproval = createMetricLineChart(
      'timeToApprovalChart',
      breakdownLabels,
      <%= breakdown[:datasets][:avg_time_to_approval].to_json %>,
      'Avg Time to Approval (Days)',
      colors.green,
      globalMetrics.avg_time_to_approval
    );

    // Reviews & Comments Charts
    const avgReviews = <%= breakdown[:datasets][:avg_reviews].to_json %>;
    const avgComments = <%= breakdown[:datasets][:avg_comments].to_json %>;
    const avgRework = <%= breakdown[:datasets][:avg_rework_cycles].to_json %>;

    chartInstances.reviews = createMetricLineChart(
      'reviewsChart',
      breakdownLabels,
      avgReviews,
      'Avg Reviews',
      colors.purple,
      globalMetrics.avg_reviews
    );

    chartInstances.comments = createMetricLineChart(
      'commentsChart',
      breakdownLabels,
      avgComments,
      'Avg Comments',
      colors.orange,
      globalMetrics.avg_comments
    );

    chartInstances.reworkCycles = createMetricLineChart(
      'reworkCyclesChart',
      breakdownLabels,
      avgRework,
      'Avg Rework Cycles',
      colors.red,
      globalMetrics.avg_rework_cycles
    );

    // PR Size Chart
    const avgAdditionsRaw = <%= breakdown[:datasets][:avg_additions].to_json %>;
    const avgDeletionsRaw = <%= breakdown[:datasets][:avg_deletions].to_json %>;

    const sizeTotals = breakdownLabels.map((_, i) => (avgAdditionsRaw[i] || 0) + (avgDeletionsRaw[i] || 0));
    const additionsPct = avgAdditionsRaw.map((val, i) => sizeTotals[i] > 0 ? (val / sizeTotals[i] * 100) : 0);
    const deletionsPct = avgDeletionsRaw.map((val, i) => sizeTotals[i] > 0 ? (val / sizeTotals[i] * 100) : 0);

    chartInstances.prSize = createStackedBarChart(
      'prSizeChart',
      breakdownLabels,
      [
        {
          label: 'Avg Additions',
          data: additionsPct,
          backgroundColor: colors.green,
          raw: avgAdditionsRaw
        },
        {
          label: 'Avg Deletions',
          data: deletionsPct,
          backgroundColor: colors.red,
          raw: avgDeletionsRaw
        }
      ]
    );

    // Daily Breakdown Chart (100% Stacked)
    // Calculate percentages
    const mergedRaw = <%= breakdown[:datasets][:merged].to_json %>;
    const closedRaw = <%= breakdown[:datasets][:closed].to_json %>;
    const openRaw = <%= breakdown[:datasets][:open].to_json %>;
    
    const dailyTotals = breakdownLabels.map((_, i) => mergedRaw[i] + closedRaw[i] + openRaw[i]);
    
    const mergedPct = mergedRaw.map((val, i) => dailyTotals[i] > 0 ? (val / dailyTotals[i] * 100) : 0);
    const closedPct = closedRaw.map((val, i) => dailyTotals[i] > 0 ? (val / dailyTotals[i] * 100) : 0);
    const openPct = openRaw.map((val, i) => dailyTotals[i] > 0 ? (val / dailyTotals[i] * 100) : 0);

    chartInstances.dailyBreakdown = createStackedBarChart(
      'dailyBreakdownChart',
      breakdownLabels,
      [
        { label: 'Merged', data: mergedPct, backgroundColor: colors.green, raw: mergedRaw },
        { label: 'Closed', data: closedPct, backgroundColor: colors.red, raw: closedRaw },
        { label: 'Open', data: openPct, backgroundColor: colors.blue, raw: openRaw }
      ]
    );

    // Quality & Health Charts
    const ciSuccessRate = <%= breakdown[:datasets][:ci_success_rate].to_json %>;
    const mergeRate = <%= breakdown[:datasets][:merge_rate].to_json %>;
    const unreviewedRate = <%= breakdown[:datasets][:unreviewed_pr_rate].to_json %>;

    chartInstances.ciSuccessRate = createMetricLineChart(
      'ciSuccessRateChart',
      breakdownLabels,
      ciSuccessRate,
      'CI Success Rate (%)',
      colors.green,
      globalMetrics.ci_success_rate,
      'Period Avg',
      { scales: { y: { beginAtZero: true, max: 100 } } }
    );

    chartInstances.mergeRate = createMetricLineChart(
      'mergeRateChart',
      breakdownLabels,
      mergeRate,
      'Acceptance Rate (%)',
      colors.blue,
      globalMetrics.merge_rate,
      'Period Avg',
      { scales: { y: { beginAtZero: true, max: 100 } } }
    );

    chartInstances.unreviewedPRRate = createMetricLineChart(
      'unreviewedPRRateChart',
      breakdownLabels,
      unreviewedRate,
      'Unreviewed PR Rate (%)',
      colors.red,
      globalMetrics.unreviewed_pr_rate,
      'Period Avg',
      { scales: { y: { beginAtZero: true, max: 100 } } }
    );

    // Hotfix Rate Chart
    chartInstances.hotfixRate = createMetricLineChart(
      'hotfixRateChart',
      breakdownLabels,
      <%= breakdown[:datasets][:hotfix_rate].to_json %>,
      'Hotfix Rate (%)',
      colors.red,
      globalMetrics.hotfix_rate,
      'Period Avg',
      { scales: { y: { beginAtZero: true, max: 100 } } }
    );

    // Time to Green Chart
    chartInstances.timeToGreen = createMetricLineChart(
      'timeToGreenChart',
      breakdownLabels,
      <%= breakdown[:datasets][:time_to_green].to_json %>,
      'Time to Green (Hours)',
      colors.green,
      globalMetrics.time_to_green
    );

    // Deployment Frequency Chart
    const deployFrequency = <%= breakdown[:datasets][:deploy_frequency].to_json %>;

    chartInstances.deployFrequency = createBarChart(
      'deployFrequencyChart',
      breakdownLabels,
      [
        {
          label: 'Weekly Deploys',
          data: deployFrequency,
          backgroundColor: colors.yellow
        },
        createBaselineDataset(globalMetrics.deploy_frequency, 'Period Avg', colors.yellow, breakdownLabels.length)
      ]
    );

    // Top Repositories Chart
    <% top_repos = top_repositories %>
    const topRepoLabels = <%= top_repos.map { |r| r[:metric] }.to_json %>;
    const topRepoData = <%= top_repos.map { |r| r[:value] }.to_json %>;

    if (topRepoLabels.length > 0) {
      chartInstances.topRepos = createBarChart(
        'topReposChart',
        topRepoLabels,
        [{
          label: 'Pull Requests',
          data: topRepoData,
          backgroundColor: colors.yellow,
          borderColor: colors.yellow,
          borderWidth: 1
        }],
        {
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      );
    }

    // Top Contributors Chart
    <% contributors_data = top_contributors %>
    const topContributorLabels = <%= contributors_data.map { |r| r[:metric] }.to_json %>;
    const topContributorData = <%= contributors_data.map { |r| r[:value] }.to_json %>;

    if (topContributorLabels.length > 0) {
      chartInstances.topContributors = createBarChart(
        'topContributorsChart',
        topContributorLabels,
        [{
          label: 'Pull Requests',
          data: topContributorData,
          backgroundColor: colors.blue,
          borderColor: colors.blue,
          borderWidth: 1
        }],
        {
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      );
    }

    // Team Charts
    // Removed as we switched to a table view

    // ==================== PERCENTILE CHARTS ====================
<% pct = percentile_data %>
    
    // Time to First Review Percentiles Chart
    const timeToReviewPct = <%= pct[:time_to_first_review].to_json %>;
    chartInstances.timeToReviewPercentiles = new Chart(document.getElementById('timeToReviewPercentilesChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: timeToReviewPct.labels,
        datasets: [{
          label: 'Days',
          data: timeToReviewPct.percentiles,
          backgroundColor: [
            timeToReviewPct.percentiles[0] <= 1 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(255, 205, 0, 0.9)',
            timeToReviewPct.percentiles[1] <= 1 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(255, 205, 0, 0.9)',
            timeToReviewPct.percentiles[2] <= 1 ? 'rgba(34, 197, 94, 0.8)' : timeToReviewPct.percentiles[2] <= 2 ? 'rgba(255, 205, 0, 0.9)' : 'rgba(220, 38, 38, 0.8)',
            timeToReviewPct.percentiles[3] <= 2 ? 'rgba(255, 205, 0, 0.9)' : 'rgba(220, 38, 38, 0.8)'
          ],
          borderRadius: 4
        }]
      },
      options: {
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed.y} days`,
              afterLabel: () => `Target: P90 < 1 day`
            }
          },
          title: {
            display: true,
            text: `Avg: ${timeToReviewPct.stats.avg} days | ${timeToReviewPct.stats.count} data points`,
            position: 'bottom',
            font: { size: 11, weight: 'normal' }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            title: { display: true, text: 'Days' }
          }
        }
      }
    });

    // Time to Merge Percentiles Chart
    const timeToMergePct = <%= pct[:time_to_merge].to_json %>;
    chartInstances.timeToMergePercentiles = new Chart(document.getElementById('timeToMergePercentilesChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: timeToMergePct.labels,
        datasets: [{
          label: 'Days',
          data: timeToMergePct.percentiles,
          backgroundColor: [
            'rgba(59, 130, 246, 0.8)',
            'rgba(59, 130, 246, 0.7)',
            'rgba(59, 130, 246, 0.6)',
            'rgba(59, 130, 246, 0.5)'
          ],
          borderRadius: 4
        }]
      },
      options: {
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed.y} days`,
              afterLabel: () => `Min: ${timeToMergePct.stats.min} | Max: ${timeToMergePct.stats.max}`
            }
          },
          title: {
            display: true,
            text: `Avg: ${timeToMergePct.stats.avg} days | ${timeToMergePct.stats.count} data points`,
            position: 'bottom',
            font: { size: 11, weight: 'normal' }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            title: { display: true, text: 'Days' }
          }
        }
      }
    });

    // PR Size Percentiles Chart
    const prSizePct = <%= pct[:pr_size].to_json %>;
    chartInstances.prSizePercentiles = new Chart(document.getElementById('prSizePercentilesChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: prSizePct.labels,
        datasets: [
          {
            label: 'Additions',
            data: prSizePct.additions.percentiles,
            backgroundColor: 'rgba(34, 197, 94, 0.8)',
            borderRadius: 4
          },
          {
            label: 'Deletions',
            data: prSizePct.deletions.percentiles,
            backgroundColor: 'rgba(220, 38, 38, 0.8)',
            borderRadius: 4
          }
        ]
      },
      options: {
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} lines`
            }
          },
          title: {
            display: true,
            text: `Total (Add+Del) - Avg: ${prSizePct.stats.avg} | P90: ${prSizePct.percentiles[2]} lines`,
            position: 'bottom',
            font: { size: 11, weight: 'normal' }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            title: { display: true, text: 'Lines Changed' }
          }
        }
      }
    });

    // Weekly PR Throughput Chart
    const weeklyPRData = <%= pct[:weekly_throughput].to_json %>;
    chartInstances.weeklyThroughput = new Chart(document.getElementById('weeklyThroughputChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: weeklyPRData.labels,
        datasets: [
          {
            label: 'PRs Created',
            data: weeklyPRData.created,
            borderColor: 'rgba(59, 130, 246, 0.8)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: false
          },
          {
            label: 'PRs Merged',
            data: weeklyPRData.merged,
            borderColor: 'rgba(34, 197, 94, 0.8)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            fill: false
          },
          {
            type: 'line',
            label: `Created P50 (${weeklyPRData.percentiles.created[0]})`,
            data: new Array(weeklyPRData.labels.length).fill(weeklyPRData.percentiles.created[0]),
            borderColor: 'rgba(59, 130, 246, 0.4)',
            borderDash: [5, 5],
            pointRadius: 0,
            borderWidth: 2,
            fill: false
          },
          {
            type: 'line',
            label: `Merged P50 (${weeklyPRData.percentiles.merged[0]})`,
            data: new Array(weeklyPRData.labels.length).fill(weeklyPRData.percentiles.merged[0]),
            borderColor: 'rgba(34, 197, 94, 0.4)',
            borderDash: [5, 5],
            pointRadius: 0,
            borderWidth: 2,
            fill: false
          }
        ]
      },
      options: {
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          y: { 
            beginAtZero: true,
            title: { display: true, text: 'PRs per Week' }
          }
        }
      }
    });

    // Time to Green Percentiles Chart
    const timeToGreenPct = <%= pct[:time_to_green].to_json %>;
    chartInstances.timeToGreenPercentiles = new Chart(document.getElementById('timeToGreenPercentilesChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: timeToGreenPct.labels,
        datasets: [{
          label: 'Hours',
          data: timeToGreenPct.percentiles,
          backgroundColor: [
            timeToGreenPct.percentiles[0] <= 0.5 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(255, 205, 0, 0.9)',
            timeToGreenPct.percentiles[1] <= 0.5 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(255, 205, 0, 0.9)',
            timeToGreenPct.percentiles[2] <= 0.5 ? 'rgba(34, 197, 94, 0.8)' : timeToGreenPct.percentiles[2] <= 1 ? 'rgba(255, 205, 0, 0.9)' : 'rgba(220, 38, 38, 0.8)',
            timeToGreenPct.percentiles[3] <= 1 ? 'rgba(255, 205, 0, 0.9)' : 'rgba(220, 38, 38, 0.8)'
          ],
          borderRadius: 4
        }]
      },
      options: {
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed.y} hours`,
              afterLabel: () => `Target: P90 < 30 min (0.5h)`
            }
          },
          title: {
            display: true,
            text: `Avg: ${timeToGreenPct.stats.avg} hours | ${timeToGreenPct.stats.count} data points`,
            position: 'bottom',
            font: { size: 11, weight: 'normal' }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            title: { display: true, text: 'Hours' }
          }
        }
      }
    });

    // CI Success Rate Histogram Chart
    const ciSuccessPct = <%= pct[:ci_success_rate].to_json %>;
    chartInstances.ciSuccessHistogram = new Chart(document.getElementById('ciSuccessHistogramChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: ciSuccessPct.distribution.map(d => d.range),
        datasets: [{
          label: 'Days',
          data: ciSuccessPct.distribution.map(d => d.count),
          backgroundColor: [
            'rgba(220, 38, 38, 0.8)',   // 0-50% - red
            'rgba(249, 115, 22, 0.8)',  // 50-75% - orange
            'rgba(255, 205, 0, 0.9)',   // 75-90% - yellow
            'rgba(34, 197, 94, 0.6)',   // 90-95% - light green
            'rgba(34, 197, 94, 0.8)'    // 95-100% - green
          ],
          borderRadius: 4
        }]
      },
      options: {
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.parsed.y} days with ${ctx.label} CI success rate`
            }
          },
          title: {
            display: true,
            text: `P50: ${ciSuccessPct.percentiles[0]}% | P90: ${ciSuccessPct.percentiles[2]}%`,
            position: 'bottom',
            font: { size: 11, weight: 'normal' }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            title: { display: true, text: 'Number of Days' },
            ticks: { stepSize: 1 }
          },
          x: {
            title: { display: true, text: 'CI Success Rate Range' }
          }
        }
      }
    });
    }
    
    // Heatmap Logic
    const commitActivity = <%= commit_activity.to_json %>;

    // Initial render
    const excludeBotsCheckbox = document.getElementById('excludeBotsToggle');
    renderHeatmap('heatmap-container', commitActivity, excludeBotsCheckbox ? excludeBotsCheckbox.checked : false);

    // Re-render on resize
    let resizeTimeoutHeatmap;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeoutHeatmap);
      const excludeBots = excludeBotsCheckbox ? excludeBotsCheckbox.checked : false;
      resizeTimeoutHeatmap = setTimeout(() => renderHeatmap('heatmap-container', commitActivity, excludeBots), 250);
    });

    function toggleToc() {
      const menu = document.getElementById('tocMenu');
      menu.classList.toggle('visible');
    }
    
    // Close TOC when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('tocMenu');
      const fab = document.querySelector('.toc-fab');
      if (menu && menu.classList.contains('visible') && !menu.contains(e.target) && !fab.contains(e.target)) {
        menu.classList.remove('visible');
      }
    });

    // Create charts on load
    createCharts();
  </script>
</body>
</html>
